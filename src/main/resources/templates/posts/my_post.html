<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>My Posts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    .card:hover {
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      transform: scale(1.01);
      transition: 0.2s ease-in-out;
    }
    .post-meta i {
      margin-right: 4px;
    }
  </style>
</head>
<body>

<div class="container py-5">

  <div class="mb-4 d-flex justify-content-between align-items-center">
    <a href="/" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Home
    </a>
    <h1 class="mb-0 text-center flex-grow-1">My Posts</h1>
    <a href="/posts/new" class="btn btn-success">
      <i class="bi bi-plus-circle"></i> New Post
    </a>
  </div>

  <div class="mb-4 d-flex justify-content-center gap-2 flex-wrap">
    <a href="/posts/drafts" class="btn btn-outline-dark btn-sm">
      <i class="bi bi-file-earmark"></i> Drafts
    </a>
    <a href="/posts/my-reports" class="btn btn-outline-dark btn-sm">
      <i class="bi bi-flag"></i> Reports
    </a>
  </div>


  <!-- Alert messages -->
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${success}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <!-- List of Posts -->
  <div class="row row-cols-1 row-cols-md-2 g-4" th:if="${!#lists.isEmpty(posts)}">
    <div class="col" th:each="post : ${posts}">
      <div class="card post-card h-100 position-relative">
        <div class="dropdown" th:if="${#authentication.name == post.user?.username}">
          <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="bi bi-gear"></i>
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" th:href="@{'/posts/' + ${post.id} + '/edit'}">Edit</a></li>
            <li>
              <form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
                <input type="hidden" name="redirectUrl" value="/posts" />
                <button class="dropdown-item text-danger" type="submit">Delete</button>
              </form>
            </li>
          </ul>
        </div>
        <div class="card-body">

          <div th:if="${post.imageUrl != null}" class="mb-3 text-center">
            <img th:src="@{${post.imageUrl}}" alt="Post Image" class="img-fluid rounded" style="max-height: 200px; object-fit: cover;">
          </div>

          <h5 class="card-title" th:text="${post.title}">Post Title</h5>
          <p class="card-text" th:text="${post.content}">Post content...</p>


          <!-- Post image -->
          <img th:if="${post.imageUrl != null and (#strings.endsWith(post.imageUrl, '.png') or
                                         #strings.endsWith(post.imageUrl, '.jpg') or
                                         #strings.endsWith(post.imageUrl, '.jpeg'))}"
               th:src="@{${post.imageUrl}}"
               style="width: 200px;" />

          <!-- Show video if imageUrl is not null and ends with .mp4 -->
          <video th:if="${post.imageUrl != null and #strings.endsWith(post.imageUrl, '.mp4')}"
                 width="320" height="240" controls>
            <source th:src="@{${post.imageUrl}}" type="video/mp4" />
          </video>


          <!-- Like/Dislike -->
          <div class="mb-3 d-flex align-items-center gap-2">
            <form th:action="@{'/posts/' + ${post.id} + '/like'}" method="post">
              <button type="submit" class="btn btn-outline-success" th:disabled="${likedByUser}">
                <i class="bi bi-hand-thumbs-up"></i> Like
              </button>
            </form>
            <form th:action="@{'/posts/' + ${post.id} + '/dislike'}" method="post">
              <button type="submit" class="btn btn-outline-danger" th:disabled="${dislikedByUser}">
                <i class="bi bi-hand-thumbs-down"></i> Dislike
              </button>
            </form>
            <span class="ms-3 text-muted">
        üëç <span th:text="${likeCount}">0</span> &nbsp; üëé <span th:text="${dislikeCount}">0</span>
    </span>
          </div>

          <!-- Comment Section -->
          <div class="mt-5">
            <h5 class="mb-3">Comments</h5>

            <div th:if="${post.comments != null}">
              <ul class="list-group mb-4">
                <li class="list-group-item"
                    th:each="comment, iterStat : ${post.comments}"
                    th:if="${iterStat.index < 5}">
                  <strong th:text="${comment.user.fullName}">User</strong>:
                  <span th:text="${comment.content}">Comment content</span><br>
                  <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'dd/MM/yyyy HH:mm')}">Date</small>
                </li>
              </ul>

              <!-- N√∫t xem th√™m -->
              <div th:if="${#lists.size(post.comments) > 5}">
                <a th:href="@{'/posts/' + ${post.id}}" class="btn btn-sm btn-link">More comment...</a>
              </div>
            </div>

            <!-- Form b√¨nh lu·∫≠n -->
            <form th:action="@{'/posts/' + ${post.id} + '/comment'}" method="post">
              <div class="mb-3">
                <textarea name="content" class="form-control" rows="3" placeholder="Enter comment..." required></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Send Comment
              </button>
            </form>
          </div>

          <div class="post-meta mt-auto">
            <span><i class="bi bi-person"></i> <span th:text="${post.user.username}">Author</span></span>
            <span class="ms-3"><i class="bi bi-clock"></i> <span th:text="${#temporals.format(post.createdAt, 'dd/MM/yyyy HH:mm')}">Posted date</span></span>
          </div>
        </div>
        <div class="card-footer bg-transparent">
          <a th:href="@{'/posts/' + ${post.id}}" class="btn btn-outline-primary w-100">View Details</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div th:if="${#lists.isEmpty(posts)}" class="text-center py-5">
    <i class="bi bi-journal-x" style="font-size: 4rem; color: #ccc;"></i>
    <h3 class="mt-3">No posts available</h3>
    <p class="text-muted">Be the first to create a post!</p>
    <a href="/posts/new" class="btn btn-primary mt-2">Create New Post</a>
  </div>
  </div>

  <!-- If no posts exist -->
  <div th:if="${#lists.isEmpty(posts)}" class="text-center py-5">
    <i class="bi bi-journal-x" style="font-size: 4rem; color: #ccc;"></i>
    <h3 class="mt-3">You haven‚Äôt written any posts yet</h3>
    <a href="/posts" class="btn btn-primary mt-2">
      <i class="bi bi-plus-circle"></i> Write Your First Post
    </a>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
